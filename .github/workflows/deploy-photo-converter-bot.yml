name: Deploy photo-converter monorepo

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  AR_REPO: orochimary
  CONVERTER_IMAGE_NAME: photo-converter
  BOT_IMAGE_NAME: photo-convert-bot

jobs:
  deploy_converter:
    name: Deploy converter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required configuration
        shell: bash
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}
          GCP_SA_EMAIL: ${{ secrets.GCP_SA_EMAIL }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          CLOUD_RUN_CONVERTER_SERVICE: ${{ secrets.CLOUD_RUN_CONVERTER_SERVICE }}
          CONVERTER_API_KEY: ${{ secrets.CONVERTER_API_KEY }}
        run: |
          set -euo pipefail

          required=(
            GCP_PROJECT
            GCP_WIF_PROVIDER
            GCP_SA_EMAIL
            GCP_REGION
            CLOUD_RUN_CONVERTER_SERVICE
            CONVERTER_API_KEY
          )

          for key in "${required[@]}"; do
            if [[ -z "${!key:-}" ]]; then
              echo "Missing required secret: $key" >&2
              exit 1
            fi
          done

      - name: Normalize and validate image/repo names
        id: names
        shell: bash
        run: |
          set -euo pipefail

          ar_repo_lower="$(echo "${AR_REPO}" | tr '[:upper:]' '[:lower:]')"
          converter_image_lower="$(echo "${CONVERTER_IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')"

          validate_re='^[a-z0-9]+([._-][a-z0-9]+)*$'
          for value in "$ar_repo_lower" "$converter_image_lower"; do
            if [[ ! "$value" =~ $validate_re ]]; then
              echo "Invalid Artifact Registry/image name: $value" >&2
              exit 1
            fi
          done

          echo "ar_repo=$ar_repo_lower" >> "$GITHUB_OUTPUT"
          echo "converter_image=$converter_image_lower" >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        shell: bash
        run: |
          gcloud auth configure-docker "${{ secrets.GCP_REGION }}-docker.pkg.dev" --quiet

      - name: Verify authentication and permissions
        shell: bash
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT }}
          REGION: ${{ secrets.GCP_REGION }}
        run: |
          set -euo pipefail

          echo "::group::Verifying GCP authentication"
          if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q .; then
            echo "::error::No active GCP authentication found"
            exit 1
          fi

          active_account=$(gcloud auth list --filter=status:ACTIVE --format="value(account)" | head -n1)
          echo "Authenticated as: $active_account"
          echo "::endgroup::"

          echo "::group::Verifying Artifact Registry access"
          ar_repo="${REGION}-docker.pkg.dev/${PROJECT_ID}/${{ steps.names.outputs.ar_repo }}"

          if ! gcloud artifacts repositories describe "${{ steps.names.outputs.ar_repo }}" \
              --location="${REGION}" \
              --project="${PROJECT_ID}" &>/dev/null; then
            echo "::error::Artifact Registry repository not found: ${ar_repo}"
            echo "Please create the repository or verify the name is correct"
            exit 1
          fi

          echo "Artifact Registry repository exists: ${ar_repo}"

          # Test if we can list images (validates read access)
          if ! gcloud artifacts docker images list "${ar_repo}" --project="${PROJECT_ID}" &>/dev/null; then
            echo "::warning::Cannot list images in repository (this may be normal for new repos)"
          fi
          echo "::endgroup::"

          echo "::group::Verifying Docker authentication"
          if ! docker login "${REGION}-docker.pkg.dev" --username=oauth2accesstoken --password="$(gcloud auth print-access-token)" &>/dev/null; then
            echo "::error::Docker authentication failed"
            exit 1
          fi
          echo "Docker successfully authenticated to Artifact Registry"
          echo "::endgroup::"

      - name: Build and push converter image
        id: build_push_converter
        shell: bash
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT }}
          REGION: ${{ secrets.GCP_REGION }}
        run: |
          set -euo pipefail

          image_uri="${REGION}-docker.pkg.dev/${PROJECT_ID}/${{ steps.names.outputs.ar_repo }}/${{ steps.names.outputs.converter_image }}:${GITHUB_SHA}"

          echo "::group::Building Docker image"
          echo "Building image: $image_uri"
          if ! docker build -t "$image_uri" ./converter; then
            echo "::error::Docker build failed"
            exit 1
          fi
          echo "::endgroup::"

          echo "::group::Pushing Docker image"
          echo "Pushing image: $image_uri"

          # Retry logic for docker push (network operation)
          max_attempts=4
          attempt=1
          backoff=2

          while [ $attempt -le $max_attempts ]; do
            echo "Push attempt $attempt of $max_attempts..."

            if docker push "$image_uri"; then
              echo "Successfully pushed image"
              echo "::endgroup::"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "::error::Failed to push image after $max_attempts attempts"
                echo "::error::Verify that:"
                echo "::error::  1. Service account has 'Artifact Registry Writer' role"
                echo "::error::  2. Workload Identity Federation is correctly configured"
                echo "::error::  3. Repository exists: ${REGION}-docker.pkg.dev/${PROJECT_ID}/${{ steps.names.outputs.ar_repo }}"
                exit 1
              fi

              echo "Push failed, waiting ${backoff}s before retry..."
              sleep $backoff
              backoff=$((backoff * 2))
              attempt=$((attempt + 1))
            fi
          done

          echo "image_uri=$image_uri" >> "$GITHUB_OUTPUT"

      - name: Deploy converter to Cloud Run
        id: deploy_converter
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ secrets.CLOUD_RUN_CONVERTER_SERVICE }}
          region: ${{ secrets.GCP_REGION }}
          image: ${{ steps.build_push_converter.outputs.image_uri }}
          # Note: Converter authentication can be configured in two ways:
          # 1. --allow-unauthenticated (simpler): Anyone with the URL + API key can access
          # 2. --no-allow-unauthenticated (more secure): Requires ID token + API key
          #    If using option 2, grant the bot service account "roles/run.invoker" on this service
          env_vars: |
            CONVERTER_API_KEY=${{ secrets.CONVERTER_API_KEY }}
            MAX_FILE_MB=${{ vars.MAX_FILE_MB || '40' }}

  deploy_bot:
    name: Deploy bot
    runs-on: ubuntu-latest
    needs: deploy_converter

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required configuration
        shell: bash
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}
          GCP_SA_EMAIL: ${{ secrets.GCP_SA_EMAIL }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          CLOUD_RUN_BOT_SERVICE: ${{ secrets.CLOUD_RUN_BOT_SERVICE }}
          CONVERTER_API_KEY: ${{ secrets.CONVERTER_API_KEY }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ALLOWED_EDITORS: ${{ vars.ALLOWED_EDITORS }}
          CHAT_ID: ${{ vars.CHAT_ID }}
          TOPIC_SOURCE_ID: ${{ vars.TOPIC_SOURCE_ID }}
          TOPIC_CONVERTED_ID: ${{ vars.TOPIC_CONVERTED_ID }}
        run: |
          set -euo pipefail

          required=(
            GCP_PROJECT
            GCP_WIF_PROVIDER
            GCP_SA_EMAIL
            GCP_REGION
            CLOUD_RUN_BOT_SERVICE
            CONVERTER_API_KEY
            ALLOWED_EDITORS
            CHAT_ID
            TOPIC_SOURCE_ID
            TOPIC_CONVERTED_ID
          )

          for key in "${required[@]}"; do
            if [[ -z "${!key:-}" ]]; then
              echo "Missing required secret or variable: $key" >&2
              exit 1
            fi
          done

          if [[ -z "${BOT_TOKEN:-}" && -z "${TELEGRAM_BOT_TOKEN:-}" ]]; then
            echo "Missing required secret: BOT_TOKEN or TELEGRAM_BOT_TOKEN" >&2
            exit 1
          fi

      - name: Normalize and validate image/repo names
        id: names
        shell: bash
        run: |
          set -euo pipefail

          ar_repo_lower="$(echo "${AR_REPO}" | tr '[:upper:]' '[:lower:]')"
          bot_image_lower="$(echo "${BOT_IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')"

          validate_re='^[a-z0-9]+([._-][a-z0-9]+)*$'
          for value in "$ar_repo_lower" "$bot_image_lower"; do
            if [[ ! "$value" =~ $validate_re ]]; then
              echo "Invalid Artifact Registry/image name: $value" >&2
              exit 1
            fi
          done

          echo "ar_repo=$ar_repo_lower" >> "$GITHUB_OUTPUT"
          echo "bot_image=$bot_image_lower" >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        shell: bash
        run: |
          gcloud auth configure-docker "${{ secrets.GCP_REGION }}-docker.pkg.dev" --quiet

      - name: Verify authentication and permissions
        shell: bash
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT }}
          REGION: ${{ secrets.GCP_REGION }}
        run: |
          set -euo pipefail

          echo "::group::Verifying GCP authentication"
          if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q .; then
            echo "::error::No active GCP authentication found"
            exit 1
          fi

          active_account=$(gcloud auth list --filter=status:ACTIVE --format="value(account)" | head -n1)
          echo "Authenticated as: $active_account"
          echo "::endgroup::"

          echo "::group::Verifying Artifact Registry access"
          ar_repo="${REGION}-docker.pkg.dev/${PROJECT_ID}/${{ steps.names.outputs.ar_repo }}"

          if ! gcloud artifacts repositories describe "${{ steps.names.outputs.ar_repo }}" \
              --location="${REGION}" \
              --project="${PROJECT_ID}" &>/dev/null; then
            echo "::error::Artifact Registry repository not found: ${ar_repo}"
            echo "Please create the repository or verify the name is correct"
            exit 1
          fi

          echo "Artifact Registry repository exists: ${ar_repo}"
          echo "::endgroup::"

          echo "::group::Verifying Docker authentication"
          if ! docker login "${REGION}-docker.pkg.dev" --username=oauth2accesstoken --password="$(gcloud auth print-access-token)" &>/dev/null; then
            echo "::error::Docker authentication failed"
            exit 1
          fi
          echo "Docker successfully authenticated to Artifact Registry"
          echo "::endgroup::"

      - name: Build and push bot image
        id: build_push_bot
        shell: bash
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT }}
          REGION: ${{ secrets.GCP_REGION }}
        run: |
          set -euo pipefail

          image_uri="${REGION}-docker.pkg.dev/${PROJECT_ID}/${{ steps.names.outputs.ar_repo }}/${{ steps.names.outputs.bot_image }}:${GITHUB_SHA}"

          echo "::group::Building Docker image"
          echo "Building image: $image_uri"
          if ! docker build -t "$image_uri" ./bot; then
            echo "::error::Docker build failed"
            exit 1
          fi
          echo "::endgroup::"

          echo "::group::Pushing Docker image"
          echo "Pushing image: $image_uri"

          # Retry logic for docker push (network operation)
          max_attempts=4
          attempt=1
          backoff=2

          while [ $attempt -le $max_attempts ]; do
            echo "Push attempt $attempt of $max_attempts..."

            if docker push "$image_uri"; then
              echo "Successfully pushed image"
              echo "::endgroup::"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "::error::Failed to push image after $max_attempts attempts"
                echo "::error::Verify that:"
                echo "::error::  1. Service account has 'Artifact Registry Writer' role"
                echo "::error::  2. Workload Identity Federation is correctly configured"
                echo "::error::  3. Repository exists: ${REGION}-docker.pkg.dev/${PROJECT_ID}/${{ steps.names.outputs.ar_repo }}"
                exit 1
              fi

              echo "Push failed, waiting ${backoff}s before retry..."
              sleep $backoff
              backoff=$((backoff * 2))
              attempt=$((attempt + 1))
            fi
          done

          echo "image_uri=$image_uri" >> "$GITHUB_OUTPUT"

      - name: Get converter URL
        id: get_converter_url
        shell: bash
        run: |
          set -euo pipefail

          converter_url="$(gcloud run services describe "${{ secrets.CLOUD_RUN_CONVERTER_SERVICE }}" \
            --region="${{ secrets.GCP_REGION }}" \
            --project="${{ secrets.GCP_PROJECT }}" \
            --format='value(status.url)')"

          if [[ -z "$converter_url" ]]; then
            echo "Failed to resolve converter URL" >&2
            exit 1
          fi

          echo "Converter URL: $converter_url"
          echo "converter_url=$converter_url" >> "$GITHUB_OUTPUT"

      - name: Deploy bot to Cloud Run
        id: deploy_bot
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ secrets.CLOUD_RUN_BOT_SERVICE }}
          region: ${{ secrets.GCP_REGION }}
          image: ${{ steps.build_push_bot.outputs.image_uri }}
          env_vars: |
            BOT_TOKEN=${{ secrets.BOT_TOKEN != '' && secrets.BOT_TOKEN || secrets.TELEGRAM_BOT_TOKEN }}
            ALLOWED_EDITORS=${{ vars.ALLOWED_EDITORS }}
            CHAT_ID=${{ vars.CHAT_ID }}
            TOPIC_SOURCE_ID=${{ vars.TOPIC_SOURCE_ID }}
            TOPIC_CONVERTED_ID=${{ vars.TOPIC_CONVERTED_ID }}
            CONVERTER_URL=${{ steps.get_converter_url.outputs.converter_url }}
            CONVERTER_API_KEY=${{ secrets.CONVERTER_API_KEY }}
            MAX_FILE_MB=${{ vars.MAX_FILE_MB || '40' }}
            BATCH_WINDOW_SECONDS=${{ vars.BATCH_WINDOW_SECONDS }}
            PROGRESS_UPDATE_EVERY=${{ vars.PROGRESS_UPDATE_EVERY }}
